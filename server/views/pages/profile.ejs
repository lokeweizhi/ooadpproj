<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>
        <%= title %>
    </title>
    <% include ../partials/stylesheet %>
    <% include ../partials/javascript %>
    <link rel='stylesheet prefetch' href='https://use.fontawesome.com/releases/v5.0.8/css/all.css'>
    <link rel='stylesheet prefetch' href='http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css'>
    <link href="/stylesheets/profile.css" rel='stylesheet' type='text/css' />
    <style>
    .btn-primary, .btn-primary:focus {
		background-color: #E45D5D;
        border-color: #E45D5D;
        border-bottom: 4px solid #B93838;
		box-shadow: none;
		outline: none;
    }
    .btn-primary:hover, .btn-default:hover{
        background: #1C1C20;
        border-bottom: 4px solid #333;
        color:#fff
    }
    /*.nav-item > .active*/
	.nav-item > .active {
		color: #fff !important;
		background-color: #E45D5D !important;
        border-color: #E45D5D;
        border-bottom: 4px solid #B93838;
        font-family: 'Lora', sans-serif;
    }
    .nav-item > .active:hover {
		color: #fff !important;
		background-color: #1C1C20 !important;
        border-color: #1C1C20;
        border-bottom: 4px solid #333;
        font-family: 'Lora', sans-serif;
    }
    /* .tabPill .active a:hover {
        background-color: red;
    } */

    .col-lg-4 {
        border-right: 0.5px dotted gray;
        max-height: 1000000000px;
    }

    @media only screen and (max-width: 991px) {
        .col-lg-4 {
            border-right: unset;
            border-bottom:  0.5px double gray;
            height: 10%;
        }
        /* .social{
            margin-bottom: unset;
        } */
        .desc {
            border-bottom: 0.5px dotted #999999
        }
    }

    /* .social{
        margin-bottom: 10%;
    } */
    </style>
</head>

<body>
    <% include ../partials/header %>
    <div class="login-main">
        <!-- <div class="wrap"> -->
            <div class="container">
                <!--Current-->
                <header>
                </header>
                <main>
                    <div class="row">
                    <div class="left col-lg-4">
                        <div class="photo-left" style="position: relative;">
                            <img class="photo" src="images/profileImages/<%= user.imageName %>"/>
                            <button type="button" style="position: absolute;border:0; padding: 8px 8px;top: 90%;left: 50%;transform: translate(-50%, -50%);text-align: center; background-color: rgba(205,207,211,0.90);" data-toggle="modal" data-target="#createImage" class="btn btn-default">
                                Change Photo
                            </button>
                        </div>
                        <h4 class="name" id="username" name="username"><span id="verified"></span><%=user.username %></h4>

                        <!-- <p class="badge badge-success">Student(a tag)</p> -->
                        <!-- <br> -->
                        <hr style="margin-bottom: -10px; visibility:hidden;" />
                        <p class="info" style="font-style:italic;"><%=user.location %></p>
                        <!-- <div class="stats row"> -->
                        <!-- <hr> -->
                        <div class="desc" style="margin-bottom: -5%; margin-top:5%;">
                            <div>
                                <p class="number-stat" style="font-size: 16pt;"><%= itemList.length %></p>
                                <p class="desc-stat"style="margin-bottom:-3%; margin-top:0%;font-size: 10pt;">Listings</p>
                            </div>
                        </div>
                        <!-- <hr> -->
                        <br>
                        <p class="desc"><%=user.aboutMe %></p>
                        <p>Average Rating(Seller):</p>
                        <div class="social">
                            <div class="averageSeller">
                                <div class="stars-outer">
                                <div class="stars-inner"></div>
                                </div>
                                <span id="averageSellerRating"><%=review.averageSellerRating%></span>
                                <!-- <span class="number-rating"></span> -->
                            </div>
                        </div>
                        <p>Average Rating(Buyer):</p>
                        <div class="social">
                            <div class="averageBuyer">
                                <div class="stars-outer">
                                <div class="stars-inner"></div>
                                </div>
                                <span id="averageBuyerRating"><%=review.averageBuyerRating%></span>
                                <!-- <span class="number-rating"></span> -->
                            </div>
                        </div>
                    </div>
                    <div class="right col-lg-8">
                        <!-- <ul class="nav">
                        <li class="listings">Listings</li>
                        <li class="reviews">Reviews</li>
                        </ul> -->
                        <!--Tab Pills-->
                        <ul class="nav nav-pills mb-3 tabPill" id="pills-tab" role="tablist">
                            <li class="nav-item">
                                <a style="color: black" class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-home" role="tab" aria-controls="pills-home" aria-selected="true">Listings</a>
                            </li>
                            <li class="nav-item">
                                <a style="color: black;" class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false">rEVIEWS</a>
                            </li>
                        </ul>
                        <!--//tab pills-->
                        <div style="position: absolute; right: 3%;top: 20px;padding: 8px 15px;">
                            <!--Modal-->
                            <div class="modal fade" id="createImage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <form action="/profile" method="post" enctype="multipart/form-data">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                                <h4 class="modal-title" id="myModalLabel">Change avatar</h4>
                                            </div>
                
                                            <div class="modal-body">
                                                <label class="file" style="width: 100%">
                                                    <input type="file" id="image" name="image">
                                                    <span class="file-custom"></span>
                                                </label>
                                                <center>
                                                    <br>
                                                    <p>Preview: </p>
                                                    <img src="" id="img1" class="img1" height="100px" width="100px" style="width: 200px;height: 200px;border-radius: 100px;border: 1px solid #83878e;"><br>
                                                </center>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary" onclick=saveChanges()>Change Avatar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!--// Modal-->
                        </div>
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
                                <div class="row gallery" id="listingsContent">
                                    <div id="wrapper" class="animate">
                                        <div class="container-fluid">
                                            <div class="row">
                                                <% for(var i=0; i < itemList.length; i++){ %>
                                                <div class="col-md-4" data-id="<%= itemList[i].id %>">
                                                    <div class="card">
                                                        <div class="card-body">
                                                            <h5 class="card-title" >
                                                                <center>
                                                                    <img src="https://media.karousell.com/media/photos/products/2017/11/11/o_level_tys_physics_1510369822_8dc76a17.jpg" alt="<%= itemList[i].name %>"/>
                                                                </center>
                                                            </h5>
                                                            <h6 class="card-subtitle mb-2 text-secondary center itemName" style="font-size: 0.875em;font-weight: 700;font-size: 1em;padding-bottom: 0.5em;">
                                                                <%= itemList[i].name %>
                                                            </h6>
                                                            <p class="card-text text-muted">
                                                                <%if (user.location == "Singapore") {%>
                                                                    <p class="text-muted"  style="font-size: 0.875em;">SGD <strong><%= itemList[i].group %></strong></p>
                                                                <!-- <br>
                                                                <p>Condition: <strong><%= itemList[i].hobby %></strong></p> -->
                                                                <% } else if (user.location == "Malaysia") { %>
                                                                    <p class="text-muted">RM <strong><%= itemList[i].group %></strong></p>
                                                                <% } else if (user.location == "Indonesia") {%>
                                                                    <p class="text-muted">RP <strong><%= itemList[i].group %></strong></p>
                                                                <% } else {%>
                                                                    <p class="text-muted">Price: <strong><%= itemList[i].group %></strong></p>
                                                                <% } %>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                            <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                                <div id="reviewsContent">
                                    <br>
                                    <div align="center">
                                        <small><strong style="font-weight: 700;font-size: 0.8em">Filter by:</strong></small>
                                        <button class="btn btn-primary filter-button" data-filter="all">All</button>
                                        <button class="btn btn-default filter-button" data-filter="buyer">Buyer</button>
                                        <button class="btn btn-default filter-button" data-filter="seller">Seller</button>
                                    </div>
                                    <br>
                                    <ul class="list-group">
                                    <!--To be deleted-->
                                    <% var totalCount = 0 %>
                                    <% var i=0 %>
                                    <% profile.forEach(function(review){ %>
                                        <% if (totalCount < 5) { %>
                                            <% if (review.buyerOrSeller == "Seller") { %>
                                                <li class="list-group-item filter seller">
                                                <% totalCount += 1%>
                                            <% } else if(review.buyerOrSeller == "Buyer") {%>
                                                <li class="list-group-item filter buyer">
                                                <% totalCount += 1%>
                                            <% } %>
                                        <% } else {%>
                                            <% if (review.buyerOrSeller == "Seller") { %>
                                                <li class="list-group-item filter seller" id="more">
                                                <% totalCount += 1%>
                                            <% } else if(review.buyerOrSeller == "Buyer") {%>
                                                <li class="list-group-item filter buyer" id="more">
                                                <% totalCount += 1%>
                                            <% } %>
                                        <% } %>
                                                    <% totalReviews.forEach(function(imageName){ %>
                                                        <% if (imageName.username == review.by) { %>
                                                            <div class="float-left" style="padding-right:5%">
                                                                <img style="width: 74px;height: 74px;border-radius: 100px; border: 1px solid black;" src="images/profileImages/<%=imageName.imageName %>"/>
                                                                <center>
                                                                    <small class="text-muted"><em><%= review.buyerOrSeller %></em></small>
                                                                </center>
                                                            </div>
                                                        <%}%>
                                                    <% }); %>
                                                    <h4 style="font-size: 0.875em;font-weight: 700;font-size: 1em;padding-bottom: 0.5em;text-decoration: underline;">
                                                        <%= review.title %>
                                                        <div class="float-right">
                                                            <% if (review.buyerOrSeller == "Seller") { %>
                                                                <p class="list-group-item-text" id="sRating">
                                                                    <div class="sellerRating<%=i%>" style="display: none;">
                                                                        <div class="stars-outer">
                                                                        <div class="stars-inner"></div>
                                                                        </div>
                                                                        <span  class="sellerRating"><%= review.serviceRating %></span>
                                                                        <span class="number-rating"></span>
                                                                    </div>                                                  
                                                                </p>
                                                                <p class="list-group-item-text" id="bRating">
                                                                    <div class="buyerRating<%=i%>">
                                                                        <div class="stars-outer">
                                                                        <div class="stars-inner"></div>
                                                                        </div>
                                                                        <span  class="buyerRating"><%= review.buyerRating %></span>
                                                                        <span class="number-rating"></span>
                                                                    </div>                                                  
                                                                </p>
                                                                <% i+=1 %>
                                                            <% } else if (review.buyerOrSeller == "Buyer") {%>
                                                                <p class="list-group-item-text" id="sRating">
                                                                    <div class="sellerRating<%=i%>">
                                                                        <div class="stars-outer">
                                                                        <div class="stars-inner"></div>
                                                                        </div>
                                                                        <span  class="sellerRating"><%= Math.round(((review.serviceRating*0.35)+(review.priceRating*0.65)) * 10) / 10 %></span>
                                                                        <span class="number-rating"></span>
                                                                    </div>                                                
                                                                </p>
                                                                <p class="list-group-item-text" id="bRating" style="display: none;">
                                                                    <div class="buyerRating<%=i%>">
                                                                        <div class="stars-outer">
                                                                        <div class="stars-inner"></div>
                                                                        </div>
                                                                        <span  class="buyerRating"><%= review.buyerRating %></span>
                                                                        <span class="number-rating"></span>
                                                                    </div>                                                  
                                                                </p>
                                                                <% i+=1 %>
                                                            <% } %>
                                                        </div>
                                                    </h4>
                                                    <p class="text-muted"><%= review.content %></p>
                                                    <small class="text-muted">
                                                        <strong>-<span class="by" style="cursor: pointer;font-size: 0.85em;font-weight: 700;font-style: italic;" ><%= review.by %></strong>
                                                        <div class="float-right" style="font-size: 0.85em;font-style: italic;"><%= review.createdAt.getDate() + "/" + review.createdAt.getMonth() + "/" + review.createdAt.getFullYear() + ", " + review.createdAt.getHours() + ":" + review.createdAt.getMinutes()%></div>
                                                    </small>
                                                </li>                                              
                                    <% }); %>     
                                    <!--//deleted-->
                                    </ul>
                                    <br>
                                    <center><div id="checkMoreExistence"></div></center>
                                    <br>
                                </div>
                            </div>
                        </div>
                </main>
                <!--//Current-->
            </div>
        <!-- </div> -->
    </div>  
     
        <% include ../partials/footer %>
        <script src="/javascripts/profile.js"></script>  
        <script>
        // for delete button
        // $('.deleteBtn').click(function() {
        //     var profile_id = $(this).data('id');      
        //     $.ajax({
        //             url: '<%-urlPath%>'+'/'+profile_id,
        //             type: 'DELETE',
        //             success: function(result) {
        //                 console.log(result.message);
        //                 var itemToRemove = '.list-group-item[data-id='+ profile_id+']';
        //                 $(itemToRemove).remove();
        //                 calculateTotalRatings(); // to calculate the average rating
        //                 verified(); // check whether if the user is still verified
        //             },
        //             error: function(result){
        //                 alert("Unable to delete review.");
        //                 console.log(result.message);
        //             } 
        //         });  
        //     });

        // redirects to the next user
        $('.by').click(function () {
            var record_username = $(this).closest('.list-group-item').find('.by').text();
            location.href = "<%-urlPath %>/"+record_username;
        });
        </script>
        <script> 
        // display final avg stars(indv) & reviews
        var avgSeller = "<%=review.averageSellerRating%>"
        var avgBuyer = "<%=review.averageBuyerRating%>"

        var numOfReviews = "<%=profile.length%>"
        
        console.log("avgSeller:",avgSeller)
        console.log("avgBuyer:",avgBuyer)
        
        var sellerRating = new Array();
        var buyerRating = new Array();

        for (i=0;i<numOfReviews;i++){
            window["sellerRating"+i] = document.getElementsByClassName("sellerRating")[i].innerHTML;
            sellerRating[i] = new Object();
            sellerRating[i] = window["sellerRating"+i];

            window["buyerRating"+i] = document.getElementsByClassName("buyerRating")[i].innerHTML;
            buyerRating[i] = new Object();
            buyerRating[i] = window["buyerRating"+i];
        }

        // debugging use
        // for (let rating in sellerRating){
        //     console.log(sellerRating[rating]);
        // }
        for (let rating in buyerRating) {
            console.log(buyerRating[rating]);
        }

        const ratings = {
            averageSeller: avgSeller,
            averageBuyer: avgBuyer
        }

        // Total Stars
        const starsTotal = 5;

        // Run getRatings when DOM loads
        document.addEventListener('DOMContentLoaded', getRatings);
        document.addEventListener('DOMContentLoaded', getReviewRatings);

        // Form Elements
        const productSelect = document.getElementById('product-select');
        const ratingControl = document.getElementById('rating-control');

        // Init product
        let product;

        // Get ratings(profile)
        function getRatings() {
            for (let rating in ratings) {
                // Get percentage
                const starPercentage = (ratings[rating] / starsTotal) * 100;

                // Round to nearest 10
                const starPercentageRounded = `${Math.round(starPercentage / 10) * 10}%`;

                // Set width of stars-inner to percentage
                document.querySelector(`.${rating} .stars-inner`).style.width = starPercentageRounded;

                // Add number rating
                // document.querySelector(`.${rating} #averageSellerRating`).innerHTML = ratings[rating]
                // document.querySelector(`.${rating} #averageSellerRating`).innerHTML = ratings[rating]
            }
        } 
        // Get ratings(review)
        function getReviewRatings(){
            for (let rating in sellerRating) {
                // Get percentage
                const starPercentage = (sellerRating[rating] / starsTotal) * 100;

                // Round to nearest 10
                const starPercentageRounded = `${Math.round(starPercentage / 10) * 10}%`;
                // Set width of stars-inner to percentage
                document.querySelector(`.${"sellerRating"+rating} .stars-inner`).style.width = starPercentageRounded;

                // Add number rating
                //document.querySelector(`.${rating} #averageRating`).innerHTML = ratings[rating]
            }
            for (let rating in buyerRating) {
                // Get percentage
                const starPercentage = (buyerRating[rating] / starsTotal) * 100;

                // Round to nearest 10
                const starPercentageRounded = `${Math.round(starPercentage / 10) * 10}%`;
                // Set width of stars-inner to percentage
                document.querySelector(`.${"buyerRating"+rating} .stars-inner`).style.width = starPercentageRounded;
            }
        }
        </script>
        <script>
        // check whether if it's a verified user
        function verified(){
            var count = 0; // to count the num of '5/5' ratings. [condition: must hv 5 '5/5' ratings and an average of 4.5/5]
            var sRating = document.querySelectorAll("#sRating");
            for (var i=0; i<sRating.length; i++) {
                value = parseInt(document.querySelectorAll("#sRating")[i].innerHTML);
                if (value === 5){
                    console.log(value);
                    count += 1;
                }
            }
            var averageSellerRating = "<%=review.averageSellerRating%>";
            console.log("average rating:",averageSellerRating);
            if (count >= 5 && averageSellerRating >= 4.5 ) {
                console.log("YAYYYYY! YOU'RE VERIFIED!!! :D")
                var i = document.createElement("i");
                i.className = "fa fa-check-circle-o";
                i.style.cssText = "font-size:24px;color:blue";
                var verified = document.getElementById("verified");
                verified.appendChild(i);
            } else if (document.getElementsByClassName("fa fa-check-circle-o").length === 1) { // remove the rating if user drop their ratings
                var check = document.getElementsByClassName("fa fa-check-circle-o2");
                var verified = document.getElementById("verified");
                verified.remove();
            }
        }
        verified();
        </script>

</body>

</html>